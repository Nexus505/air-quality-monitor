<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitor - Real-time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .card-unit {
            font-size: 1rem;
            color: #718096;
            margin-left: 5px;
        }

        .card-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-good {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-warning {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-normal {
            background: #bee3f8;
            color: #2a4365;
        }

        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .fan-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fan-on {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .fan-off {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #742a2a;
        }

        .last-update {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå§Ô∏è Air Quality Monitor</h1>
            <p>Real-time environmental data and analytics</p>
        </div>

        <div class="dashboard">
            <!-- Air Quality Index -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üå¨Ô∏è</div>
                    <div class="card-title">Air Quality Index</div>
                </div>
                <div class="card-value" id="aqi-value">--</div>
                <div class="card-status" id="aqi-status">Loading...</div>
            </div>

            <!-- CO2 Levels -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üè≠</div>
                    <div class="card-title">CO2 Concentration</div>
                </div>
                <div class="card-value" id="co2-value">--</div>
                <div class="card-unit">ppm</div>
            </div>

            <!-- Temperature -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üå°Ô∏è</div>
                    <div class="card-title">Temperature</div>
                </div>
                <div class="card-value" id="temp-value">--</div>
                <div class="card-unit">¬∞C</div>
            </div>

            <!-- Humidity -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üíß</div>
                    <div class="card-title">Humidity</div>
                </div>
                <div class="card-value" id="hum-value">--</div>
                <div class="card-unit">%</div>
            </div>

            <!-- Smoke Detection -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üö®</div>
                    <div class="card-title">Smoke Detection</div>
                </div>
                <div class="card-value" id="smoke-value">--</div>
                <div class="card-status" id="smoke-status">Loading...</div>
            </div>

            <!-- Carbon Footprint -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üåç</div>
                    <div class="card-title">CO2 Mass</div>
                </div>
                <div class="card-value" id="co2-mass-value">--</div>
                <div class="card-unit">grams</div>
            </div>

            <!-- Chart -->
            <div class="card chart-container">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Air Quality Trends</div>
                </div>
                <canvas id="aqiChart"></canvas>
            </div>
        </div>

        <!-- Fan Control -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üí®</div>
                <div class="card-title">Ventilation Control</div>
            </div>
            <div class="controls">
                <button class="fan-btn fan-on" id="fan-on">Turn Fan ON</button>
                <button class="fan-btn fan-off" id="fan-off">Turn Fan OFF</button>
            </div>
            <div class="card-status" id="fan-status" style="text-align: center; margin-top: 15px;">
                Current Status: Loading...
            </div>
        </div>

        <div class="last-update" id="last-update">
            Last updated: --
        </div>
    </div>

    <script>
        // Blynk configuration
        const BLYNK_AUTH_TOKEN = "pS9LXOsJhn0SPbZXgG-AD8vyBVcitUdy";
        const BLYNK_SERVER = "blynk.cloud"; // or your Blynk server
        
        // Virtual pins mapping (from your Arduino code)
        const V1 = 1; // MQ135 Value
        const V2 = 2; // MQ2 Smoke Status
        const V3 = 3; // Temperature
        const V4 = 4; // Humidity
        const V5 = 5; // Fan State
        const V6 = 6; // Manual Control
        const V7 = 7; // CO2 ppm
        const V8 = 8; // CO2 grams
        const V9 = 9; // CO2 delta
        const V10 = 10; // AQI

        // Chart setup
        const ctx = document.getElementById('aqiChart').getContext('2d');
        const aqiChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Air Quality Index',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'CO2 Level (ppm)',
                    data: [],
                    borderColor: '#ed64a6',
                    backgroundColor: 'rgba(237, 100, 166, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#2d3748',
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // WebSocket connection for real-time data
        let ws;
        let chartData = {
            labels: [],
            aqi: [],
            co2: []
        };

        function connectWebSocket() {
            try {
                ws = new WebSocket(`wss://${BLYNK_SERVER}/ws/${BLYNK_AUTH_TOKEN}`);
                
                ws.onopen = function() {
                    console.log('Connected to Blynk');
                    updateStatus('Connected to device', 'status-good');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    processBlynkData(data);
                };
                
                ws.onclose = function() {
                    console.log('Disconnected from Blynk');
                    updateStatus('Disconnected - Retrying...', 'status-warning');
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateStatus('Connection error', 'status-warning');
                };
                
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                // Fallback to HTTP polling
                startHTTPPolling();
            }
        }

        // HTTP polling fallback
        function startHTTPPolling() {
            setInterval(fetchBlynkData, 5000);
            fetchBlynkData();
        }

        async function fetchBlynkData() {
            try {
                // Fetch all virtual pins
                const pins = [V1, V2, V3, V4, V5, V7, V8, V9, V10];
                for (const pin of pins) {
                    const response = await fetch(`https://${BLYNK_SERVER}/external/api/get?token=${BLYNK_AUTH_TOKEN}&pin=V${pin}`);
                    const value = await response.text();
                    processPinData(pin, value);
                }
                updateLastUpdate();
            } catch (error) {
                console.error('HTTP polling error:', error);
                updateStatus('Connection error', 'status-warning');
            }
        }

        function processBlynkData(data) {
            // Process WebSocket data from Blynk
            if (data.pin && data.value !== undefined) {
                processPinData(data.pin, data.value);
            }
            updateLastUpdate();
        }

        function processPinData(pin, value) {
            const now = new Date().toLocaleTimeString();
            
            switch(parseInt(pin)) {
                case V1:
                    // MQ135 Raw Value
                    break;
                case V2:
                    document.getElementById('smoke-value').textContent = value;
                    document.getElementById('smoke-status').textContent = value === 'SMOKE' ? 'Smoke Detected!' : 'No Smoke';
                    document.getElementById('smoke-status').className = `card-status ${value === 'SMOKE' ? 'status-warning' : 'status-good'}`;
                    break;
                case V3:
                    document.getElementById('temp-value').textContent = parseFloat(value).toFixed(1);
                    break;
                case V4:
                    document.getElementById('hum-value').textContent = parseFloat(value).toFixed(1);
                    break;
                case V5:
                    updateFanStatus(parseInt(value));
                    break;
                case V7:
                    document.getElementById('co2-value').textContent = parseInt(value);
                    break;
                case V8:
                    document.getElementById('co2-mass-value').textContent = parseFloat(value).toFixed(2);
                    break;
                case V10:
                    const aqi = parseInt(value);
                    document.getElementById('aqi-value').textContent = aqi;
                    updateAqiStatus(aqi);
                    
                    // Update chart
                    chartData.labels.push(now);
                    chartData.aqi.push(aqi);
                    chartData.co2.push(parseInt(document.getElementById('co2-value').textContent || 0));
                    
                    // Keep only last 20 data points
                    if (chartData.labels.length > 20) {
                        chartData.labels.shift();
                        chartData.aqi.shift();
                        chartData.co2.shift();
                    }
                    
                    aqiChart.data.labels = chartData.labels;
                    aqiChart.data.datasets[0].data = chartData.aqi;
                    aqiChart.data.datasets[1].data = chartData.co2;
                    aqiChart.update();
                    break;
            }
        }

        function updateAqiStatus(aqi) {
            const statusElement = document.getElementById('aqi-status');
            if (aqi <= 50) {
                statusElement.textContent = 'Excellent';
                statusElement.className = 'card-status status-good';
            } else if (aqi <= 100) {
                statusElement.textContent = 'Good';
                statusElement.className = 'card-status status-normal';
            } else if (aqi <= 150) {
                statusElement.textContent = 'Moderate';
                statusElement.className = 'card-status status-warning';
            } else {
                statusElement.textContent = 'Poor';
                statusElement.className = 'card-status status-warning';
            }
        }

        function updateFanStatus(state) {
            const statusElement = document.getElementById('fan-status');
            const onBtn = document.getElementById('fan-on');
            const offBtn = document.getElementById('fan-off');
            
            if (state === 1) {
                statusElement.textContent = 'Current Status: FAN IS ON';
                statusElement.className = 'card-status status-good';
                onBtn.disabled = true;
                offBtn.disabled = false;
            } else {
                statusElement.textContent = 'Current Status: FAN IS OFF';
                statusElement.className = 'card-status status-normal';
                onBtn.disabled = false;
                offBtn.disabled = true;
            }
        }

        function updateStatus(message, statusClass) {
            // You can add a connection status indicator if needed
            console.log(message);
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                `Last updated: ${now.toLocaleString()}`;
        }

        // Fan control functions
        async function controlFan(state) {
            try {
                const response = await fetch(`https://${BLYNK_SERVER}/external/api/update?token=${BLYNK_AUTH_TOKEN}&pin=V6&value=${state}`);
                if (response.ok) {
                    console.log(`Fan ${state === 1 ? 'ON' : 'OFF'} command sent`);
                }
            } catch (error) {
                console.error('Error controlling fan:', error);
            }
        }

        // Event listeners
        document.getElementById('fan-on').addEventListener('click', () => controlFan(1));
        document.getElementById('fan-off').addEventListener('click', () => controlFan(0));

        // Initialize connection
        connectWebSocket();

        // Add some sample data for demonstration (remove in production)
        setTimeout(() => {
            if (document.getElementById('aqi-value').textContent === '--') {
                // Demo data - remove this in production
                processPinData(V10, '45');
                processPinData(V7, '650');
                processPinData(V3, '23.5');
                processPinData(V4, '65.2');
                processPinData(V2, 'CLEAR');
                processPinData(V8, '120.5');
                processPinData(V5, '0');
            }
        }, 3000);
    </script>
</body>
</html>
